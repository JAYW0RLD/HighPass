name: 2026-HighStation-Verify-and-Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # 수동 트리거 허용

# 글로벌 환경 변수 설정 (GitHub Variables 사용)
env:
  DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME || 'YOUR_DOCKER_ID' }}
  IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME || 'highstation-backend' }}

jobs:
  # 1. 검증 단계: 테스트 통과 여부 확인
  test:
    name: "코드 무결성 검증 (CI)"
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD || 'postgres' }}
          POSTGRES_DB: highstation
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: 코드 가져오기
        uses: actions/checkout@v4

      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 의존성 설치
        run: npm install --legacy-peer-deps

      - name: 테스트 실행
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/highstation
        run: npm test

  # 2. 배포 단계: 테스트 성공 시에만 빌드 및 푸시
  build-and-push:
    name: "이미지 빌드 및 배포 (CD)"
    needs: test
    if: success()
    runs-on: ubuntu-latest
    
    steps:
      - name: 코드 가져오기
        uses: actions/checkout@v4

      - name: 도커 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Buildx 설정
        uses: docker/setup-buildx-action@v3

      - name: 백엔드 이미지 빌드/푸시
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
